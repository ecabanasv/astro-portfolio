---
import { siteMetadata } from '../data/head';

const links = [
  { href: "#about", id: "about", label: "About" },
  { href: "#resume", id: "resume", label: "Resume" },
  { href: "#portfolio", id: "portfolio", label: "Portfolio" },
  { href: "#blog", id: "blog", label: "Blog" },
  { href: "#contact", id: "contact", label: "Contact" },
];
const navId = "primary-navigation";
const homeHref = (() => {
  try {
    return new URL(".", siteMetadata.url).pathname;
  } catch {
    return "/";
  }
})();
const basePath = (() => {
  try {
    return new URL(".", siteMetadata.url).pathname;
  } catch {
    return "/";
  }
})();
---
<header class="sticky top-0 z-50 border-b border-white/50 bg-white/70 backdrop-blur-xl transition dark:border-white/10 dark:bg-gray-950/70">
  <nav class="container flex h-16 items-center justify-between gap-4" aria-label="Primary navigation">
    <a href={homeHref} class="font-semibold tracking-tight text-gray-900 dark:text-white">demo-portfolio.example</a>
    <button
      type="button"
      class="inline-flex items-center gap-2 rounded-md border border-transparent px-3 py-2 text-sm font-medium md:hidden"
      aria-expanded="false"
      aria-label="Open navigation menu"
      aria-controls={navId}
      data-nav-toggle
    >
      <span>Menu</span>
      <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
        <path d="M4 7h16" />
        <path d="M4 12h16" />
        <path d="M4 17h16" />
      </svg>
    </button>
    <div
      id={navId}
      class="hidden w-full flex-col items-start gap-2 rounded-xl border border-white/50 bg-white/80 p-4 text-sm shadow-lg shadow-blue-500/5 backdrop-blur md:flex md:w-auto md:flex-row md:items-center md:gap-1 md:border-0 md:bg-transparent md:p-0 md:shadow-none dark:border-white/10 dark:bg-white/[0.05]"
      data-nav-menu
    >
      {links.map(link => (
        <a
          href={link.href}
          class="nav-link"
          data-nav-link={link.id}
          aria-current={link.id === "about" ? "page" : undefined}
        >
          {link.label}
        </a>
      ))}
    </div>
  </nav>
</header>
<script is:inline>
  if (typeof window !== 'undefined') {
    const toggle = document.querySelector('[data-nav-toggle]');
    const menu = document.querySelector('[data-nav-menu]');
    const navLinks = Array.from(document.querySelectorAll('[data-nav-link]'));
    const sections = [
      { id: 'about', el: document.querySelector('#about') },
      { id: 'resume', el: document.querySelector('#resume') },
      { id: 'portfolio', el: document.querySelector('#portfolio') },
      { id: 'blog', el: document.querySelector('#blog') },
      { id: 'contact', el: document.querySelector('#contact') }
    ].filter(item => item.el);

    if (toggle && menu) {
      const mediaQuery = window.matchMedia('(min-width: 768px)');

      const closeMenu = () => {
        toggle.setAttribute('aria-expanded', 'false');
        menu.classList.add('hidden');
      };

      const openMenu = () => {
        toggle.setAttribute('aria-expanded', 'true');
        menu.classList.remove('hidden');
        menu.querySelector('a')?.focus();
      };
      const closeOnLink = () => {
        if (window.innerWidth < 768) {
          closeMenu();
        }
      };

      toggle.addEventListener('click', () => {
        const isExpanded = toggle.getAttribute('aria-expanded') === 'true';
        if (isExpanded) {
          closeMenu();
        } else {
          openMenu();
        }
      });
      navLinks.forEach(link => link.addEventListener('click', closeOnLink));

      document.addEventListener('keydown', event => {
        if (event.key === 'Escape' && toggle.getAttribute('aria-expanded') === 'true') {
          closeMenu();
          toggle.focus();
        }
      });

      document.addEventListener('click', event => {
        const target = event.target;
        if (!(target instanceof Node)) {
          return;
        }
        const isInsideMenu = menu.contains(target);
        const isToggle = toggle.contains(target);
        if (!isInsideMenu && !isToggle && toggle.getAttribute('aria-expanded') === 'true') {
          closeMenu();
        }
      });

      const setActive = id => {
        navLinks.forEach(link => {
          const isActive = link.dataset.navLink === id;
          link.setAttribute('aria-current', isActive ? 'page' : undefined);
        });
      };

      if ('IntersectionObserver' in window && sections.length) {
        const observer = new IntersectionObserver(
          entries => {
            const visible = entries
              .filter(e => e.isIntersecting)
              .sort((a, b) => b.intersectionRatio - a.intersectionRatio)[0];
            if (visible?.target?.id) {
              setActive(visible.target.id);
            }
          },
          { rootMargin: '-45% 0px -45% 0px', threshold: [0, 0.2, 0.5, 1] }
        );
        sections.forEach(section => observer.observe(section.el));
      }

      mediaQuery.addEventListener('change', query => {
        if (query.matches) {
          menu.classList.remove('hidden');
          toggle.setAttribute('aria-expanded', 'false');
        } else {
          closeMenu();
        }
      });

      if (mediaQuery.matches) {
        menu.classList.remove('hidden');
      }
    }
  }
</script>
